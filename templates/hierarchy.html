<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hierarchy Manager - Dashboard</title>
<link rel="icon" type="image/png" href="static/social/gk.png"/>

<style>
:root {
    --primary: #3b82f6;
    --primary-hover: #2563eb;
    --danger: #ef4444;
    --danger-hover: #dc2626;
    --success: #10b981;
    --warning: #f59e0b;
    --bg: #f8fafc;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #0f172a;
    --text-light: #64748b;
    --shadow: 0 1px 3px rgba(0,0,0,0.1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
}

/* Header */
.header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 20px 0;
    margin-bottom: 32px;
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.user-email {
    font-size: 14px;
    color: var(--text-light);
}

/* Navigation Tabs */
.nav-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
}

.nav-tab {
    padding: 12px 24px;
    background: none;
    border: none;
    font-size: 15px;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}

.nav-tab:hover {
    color: var(--primary);
}

.nav-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
}

/* Tab Content */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Buttons */
.btn {
    padding: 10px 18px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-hover);
}

.btn-outline {
    background: white;
    border: 1px solid var(--border);
    color: var(--text);
}

.btn-outline:hover {
    background: var(--bg);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover {
    background: var(--danger-hover);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--shadow);
}

.stat-label {
    font-size: 13px;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--primary);
}

/* Main Card */
.card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: var(--shadow);
    overflow: hidden;
}

.card-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-title {
    font-size: 18px;
    font-weight: 700;
}

.search-box {
    padding: 8px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    width: 300px;
}

/* Table */
.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    text-align: left;
    padding: 16px 24px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: var(--bg);
}

td {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    font-size: 14px;
}

.entity-name {
    font-weight: 600;
    color: var(--text);
}

.entity-meta {
    font-size: 13px;
    color: var(--text-light);
    display: block;
    margin-top: 2px;
}

.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.badge-active {
    background: #d1fae5;
    color: var(--success);
}

.badge-inactive {
    background: #fee2e2;
    color: var(--danger);
}

.actions {
    display: flex;
    gap: 8px;
}

.icon-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: var(--bg);
    color: var(--text-light);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.icon-btn:hover {
    background: var(--primary);
    color: white;
}

.icon-btn.delete:hover {
    background: var(--danger);
    color: white;
}

.icon-btn svg {
    width: 16px;
    height: 16px;
    stroke-width: 2;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--card);
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: 18px;
    font-weight: 700;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-light);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
}

.close-btn:hover {
    background: var(--bg);
    color: var(--text);
}

.modal-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    transition: all 0.2s;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.error-message {
    background: #fee2e2;
    color: var(--danger);
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 14px;
    display: none;
}

.error-message.show {
    display: block;
}

@media (max-width: 768px) {
    .container {
        padding: 16px;
    }
    
    .header-content {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .search-box {
        width: 100%;
    }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="header-content">
        <div class="logo">
            üè¢ Hierarchy Manager
        </div>
        <div class="header-actions">
            <span class="user-email" id="userEmail">Loading...</span>
            <button class="btn btn-outline btn-sm" onclick="logout()">Logout</button>
        </div>
    </div>
</div>

<div class="container">
    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Regions</div>
            <div class="stat-value" id="totalRegions">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Clusters</div>
            <div class="stat-value" id="totalClusters">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Branches</div>
            <div class="stat-value" id="totalBranches">0</div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('regions')">Regions</button>
        <button class="nav-tab" onclick="switchTab('clusters')">Clusters</button>
        <button class="nav-tab" onclick="switchTab('branches')">Branches</button>
    </div>

    <!-- Regions Tab -->
    <div id="regions" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Regions</h2>
                <button class="btn btn-primary" onclick="openRegionModal()">
                    ‚ûï Add Region
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Region Name</th>
                            <th>Code</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="regionsTable">
                        <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Clusters Tab -->
    <div id="clusters" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Clusters</h2>
                <button class="btn btn-primary" onclick="openClusterModal()">
                    ‚ûï Add Cluster
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Cluster Name</th>
                            <th>Code</th>
                            <th>Region</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clustersTable">
                        <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Branches Tab -->
    <div id="branches" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Branches</h2>
                <button class="btn btn-primary" onclick="openBranchModal()">
                    ‚ûï Add Branch
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Branch Name</th>
                            <th>Code</th>
                            <th>Cluster</th>
                            <th>Region</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="branchesTable">
                        <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Region Modal -->
<div id="regionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="regionModalTitle">Add Region</h3>
            <button class="close-btn" onclick="closeRegionModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="error-message" id="regionError"></div>
            <form id="regionForm" onsubmit="event.preventDefault(); saveRegion();">
                <div class="form-group">
                    <label class="form-label">Region Name *</label>
                    <input type="text" class="form-input" id="regionName" required minlength="3" maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Code *</label>
                    <input type="text" class="form-input" id="regionCode" required minlength="2" maxlength="20">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeRegionModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveRegion()">Save Region</button>
        </div>
    </div>
</div>

<!-- Cluster Modal -->
<div id="clusterModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="clusterModalTitle">Add Cluster</h3>
            <button class="close-btn" onclick="closeClusterModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="error-message" id="clusterError"></div>
            <form id="clusterForm" onsubmit="event.preventDefault(); saveCluster();">
                <div class="form-group">
                    <label class="form-label">Cluster Name *</label>
                    <input type="text" class="form-input" id="clusterName" required minlength="3" maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Code *</label>
                    <input type="text" class="form-input" id="clusterCode" required minlength="2" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label">Region *</label>
                    <select class="form-select" id="clusterRegion" required>
                        <option value="">Select Region</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeClusterModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveCluster()">Save Cluster</button>
        </div>
    </div>
</div>

<!-- Branch Modal -->
<div id="branchModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="branchModalTitle">Add Branch</h3>
            <button class="close-btn" onclick="closeBranchModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="error-message" id="branchError"></div>
            <form id="branchForm" onsubmit="event.preventDefault(); saveBranch();">
                <div class="form-group">
                    <label class="form-label">Branch Name *</label>
                    <input type="text" class="form-input" id="branchName" required minlength="3" maxlength="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Code *</label>
                    <input type="text" class="form-input" id="branchCode" required minlength="2" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label">Cluster *</label>
                    <select class="form-select" id="branchCluster" required>
                        <option value="">Select Cluster</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <textarea class="form-textarea" id="branchLocation" maxlength="200"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeBranchModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveBranch()">Save Branch</button>
        </div>
    </div>
</div>

<script>
// ============================================
// CONFIGURATION & STATE
// ============================================

const API = window.location.origin;
let regionsData = [];
let clustersData = [];
let branchesData = [];
let currentEditId = null;

// ============================================
// AUTH FUNCTIONS
// ============================================

function getHeaders() {
    const token = localStorage.getItem('access_token');
    return {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    };
}

function checkAuth() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login.html';
        return false;
    }
    return true;
}

function logout() {
    localStorage.removeItem('access_token');
    window.location.href = '/login.html';
}

function loadUserInfo() {
    const email = localStorage.getItem('user_email');
    if (email) {
        document.getElementById('userEmail').textContent = email;
    }
}

// ============================================
// TAB SWITCHING
// ============================================

function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName).classList.add('active');
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function buildPatchPayload(original, updated) {
    const payload = {};
    for (const key in updated) {
        if (updated[key] !== original[key]) {
            payload[key] = updated[key];
        }
    }
    return payload;
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function updateStats() {
    document.getElementById('totalRegions').textContent = regionsData.filter(r => r.is_active).length;
    document.getElementById('totalClusters').textContent = clustersData.filter(c => c.is_active).length;
    document.getElementById('totalBranches').textContent = branchesData.filter(b => b.is_active).length;
}

function showError(tableId, message) {
    document.getElementById(tableId).innerHTML = `
        <tr>
            <td colspan="6" style="text-align: center; color: var(--danger); padding: 40px;">
                ‚ö†Ô∏è ${message}
            </td>
        </tr>
    `;
}

function showModalError(errorId, message) {
    const errorEl = document.getElementById(errorId);
    errorEl.textContent = message;
    errorEl.classList.add('show');
}

function hideModalError(errorId) {
    const errorEl = document.getElementById(errorId);
    errorEl.classList.remove('show');
}

// ============================================
// REGIONS
// ============================================

async function loadRegions() {
    try {
        const res = await fetch(`${API}/api/regions`, { headers: getHeaders() });
        if (!res.ok) throw new Error('Failed to load');
        
        regionsData = await res.json();
        renderRegions(regionsData);
        updateStats();
    } catch (err) {
        showError('regionsTable', 'Failed to load regions');
    }
}

function renderRegions(regions) {
    const tbody = document.getElementById('regionsTable');

    if (regions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="empty-state">No regions yet. Click "Add Region" to create one.</td></tr>`;
        return;
    }

    tbody.innerHTML = regions.map(r => `
        <tr>
            <td>
                <div class="entity-name">${r.name}</div>
            </td>
            <td><strong>${r.code}</strong></td>
            <td>
                <span class="badge ${r.is_active ? 'badge-active' : 'badge-inactive'}">
                    ${r.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>${formatDate(r.created_at)}</td>
            <td>
                <div class="actions">
                    <button class="icon-btn" title="Edit Region" onclick="editRegion(${r.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 013 3L7 19l-4 1 1-4 12.5-12.5z"/>
                        </svg>
                    </button>
                    <button class="icon-btn" 
                        title="${r.is_active ? 'Deactivate' : 'Activate'} Region"
                        onclick="toggleRegionStatus(${r.id}, ${r.is_active})">
                        ${r.is_active ? `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>` : `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>`}
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function openRegionModal(editId = null) {
    currentEditId = editId;
    const modal = document.getElementById('regionModal');
    const title = document.getElementById('regionModalTitle');
    
    hideModalError('regionError');
    
    if (editId) {
        const region = regionsData.find(r => r.id === editId);
        title.textContent = 'Edit Region';
        document.getElementById('regionName').value = region.name;
        document.getElementById('regionCode').value = region.code;
    } else {
        title.textContent = 'Add Region';
        document.getElementById('regionForm').reset();
    }
    
    modal.classList.add('show');
}

function closeRegionModal() {
    document.getElementById('regionModal').classList.remove('show');
    hideModalError('regionError');
    currentEditId = null;
}

async function saveRegion() {
    const name = document.getElementById('regionName').value.trim();
    const code = document.getElementById('regionCode').value.trim().toUpperCase();

    if (!name || !code) {
        showModalError('regionError', 'Please fill in all required fields');
        return;
    }

    try {
        if (currentEditId) {
            // Update existing region
            const original = regionsData.find(r => r.id === currentEditId);
            const payload = buildPatchPayload(original, { name, code });

            if (Object.keys(payload).length === 0) {
                closeRegionModal();
                return;
            }

            const res = await fetch(`${API}/api/regions/${currentEditId}`, {
                method: 'PATCH',
                headers: getHeaders(),
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to update region');
            }
        } else {
            // Create new region
            const res = await fetch(`${API}/api/regions`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ name, code })
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to create region');
            }
        }

        closeRegionModal();
        loadRegions();
    } catch (err) {
        showModalError('regionError', err.message);
    }
}

function editRegion(id) {
    openRegionModal(id);
}

async function toggleRegionStatus(id, currentStatus) {
    try {
        const res = await fetch(`${API}/api/regions/${id}`, {
            method: 'PATCH',
            headers: getHeaders(),
            body: JSON.stringify({ is_active: !currentStatus })
        });
        
        if (!res.ok) throw new Error('Failed to update status');
        loadRegions();
    } catch (err) {
        alert('Failed to update region status');
    }
}

// ============================================
// CLUSTERS
// ============================================

async function loadClusters() {
    try {
        const res = await fetch(`${API}/api/clusters`, { headers: getHeaders() });
        if (!res.ok) throw new Error('Failed to load');
        
        clustersData = await res.json();
        renderClusters(clustersData);
        updateStats();
    } catch (err) {
        showError('clustersTable', 'Failed to load clusters');
    }
}

function renderClusters(clusters) {
    const tbody = document.getElementById('clustersTable');

    if (clusters.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state">No clusters yet. Click "Add Cluster" to create one.</td></tr>`;
        return;
    }

    tbody.innerHTML = clusters.map(c => {
        const region = regionsData.find(r => r.id === c.region_id);
        return `
        <tr>
            <td>
                <div class="entity-name">${c.name}</div>
            </td>
            <td><strong>${c.code}</strong></td>
            <td>${region ? region.name : '‚Äî'}</td>
            <td>
                <span class="badge ${c.is_active ? 'badge-active' : 'badge-inactive'}">
                    ${c.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>${formatDate(c.created_at)}</td>
            <td>
                <div class="actions">
                    <button class="icon-btn" title="Edit Cluster" onclick="editCluster(${c.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 013 3L7 19l-4 1 1-4 12.5-12.5z"/>
                        </svg>
                    </button>
                    <button class="icon-btn" 
                        title="${c.is_active ? 'Deactivate' : 'Activate'} Cluster"
                        onclick="toggleClusterStatus(${c.id}, ${c.is_active})">
                        ${c.is_active ? `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>` : `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>`}
                    </button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

async function openClusterModal(editId = null) {
    currentEditId = editId;
    const modal = document.getElementById('clusterModal');
    const title = document.getElementById('clusterModalTitle');
    
    hideModalError('clusterError');
    
    // Load regions for dropdown if needed
    if (regionsData.length === 0) {
        await loadRegions();
    }
    
    const regionSelect = document.getElementById('clusterRegion');
    regionSelect.innerHTML = '<option value="">Select Region</option>' + 
        regionsData
            .filter(r => r.is_active)
            .map(r => `<option value="${r.id}">${r.name}</option>`)
            .join('');
    
    if (editId) {
        const cluster = clustersData.find(c => c.id === editId);
        title.textContent = 'Edit Cluster';
        document.getElementById('clusterName').value = cluster.name;
        document.getElementById('clusterCode').value = cluster.code;
        document.getElementById('clusterRegion').value = cluster.region_id;
    } else {
        title.textContent = 'Add Cluster';
        document.getElementById('clusterForm').reset();
    }
    
    modal.classList.add('show');
}

function closeClusterModal() {
    document.getElementById('clusterModal').classList.remove('show');
    hideModalError('clusterError');
    currentEditId = null;
}

async function saveCluster() {
    const name = document.getElementById('clusterName').value.trim();
    const code = document.getElementById('clusterCode').value.trim().toUpperCase();
    const region_id = parseInt(document.getElementById('clusterRegion').value);

    if (!name || !code || !region_id) {
        showModalError('clusterError', 'Please fill in all required fields');
        return;
    }

    try {
        if (currentEditId) {
            // Update existing cluster
            const original = clustersData.find(c => c.id === currentEditId);
            const payload = buildPatchPayload(original, { name, code, region_id });

            if (Object.keys(payload).length === 0) {
                closeClusterModal();
                return;
            }

            const res = await fetch(`${API}/api/clusters/${currentEditId}`, {
                method: 'PATCH',
                headers: getHeaders(),
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to update cluster');
            }
        } else {
            // Create new cluster
            const res = await fetch(`${API}/api/clusters`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ name, code, region_id })
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to create cluster');
            }
        }

        closeClusterModal();
        loadClusters();
    } catch (err) {
        showModalError('clusterError', err.message);
    }
}

function editCluster(id) {
    openClusterModal(id);
}

async function toggleClusterStatus(id, currentStatus) {
    try {
        const res = await fetch(`${API}/api/clusters/${id}`, {
            method: 'PATCH',
            headers: getHeaders(),
            body: JSON.stringify({ is_active: !currentStatus })
        });
        
        if (!res.ok) throw new Error('Failed to update status');
        loadClusters();
    } catch (err) {
        alert('Failed to update cluster status');
    }
}

// ============================================
// BRANCHES
// ============================================

async function loadBranches() {
    try {
        const res = await fetch(`${API}/api/branches`, { headers: getHeaders() });
        if (!res.ok) throw new Error('Failed to load');
        
        branchesData = await res.json();
        renderBranches(branchesData);
        updateStats();
    } catch (err) {
        showError('branchesTable', 'Failed to load branches');
    }
}

function renderBranches(branches) {
    const tbody = document.getElementById('branchesTable');

    if (branches.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state">No branches yet. Click "Add Branch" to create one.</td></tr>`;
        return;
    }

    tbody.innerHTML = branches.map(b => {
        const cluster = clustersData.find(c => c.id === b.cluster_id);
        const region = cluster ? regionsData.find(r => r.id === cluster.region_id) : null;

        return `
        <tr>
            <td>
                <div class="entity-name">${b.name}</div>
                ${b.location ? `<span class="entity-meta">${b.location}</span>` : ''}
            </td>
            <td><strong>${b.code}</strong></td>
            <td>${cluster ? cluster.name : '‚Äî'}</td>
            <td>${region ? region.name : '‚Äî'}</td>
            <td>
                <span class="badge ${b.is_active ? 'badge-active' : 'badge-inactive'}">
                    ${b.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <div class="actions">
                    <button class="icon-btn" title="Edit Branch" onclick="editBranch(${b.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.1 2.1 0 013 3L7 19l-4 1 1-4 12.5-12.5z"/>
                        </svg>
                    </button>
                    <button class="icon-btn" 
                        title="${b.is_active ? 'Deactivate' : 'Activate'} Branch"
                        onclick="toggleBranchStatus(${b.id}, ${b.is_active})">
                        ${b.is_active ? `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>` : `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>`}
                    </button>
                    <button class="icon-btn delete" title="Delete Branch" onclick="deleteBranch(${b.id})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6l-2 14H7L5 6"/>
                            <path d="M10 11v6M14 11v6"/>
                            <path d="M9 6V4h6v2"/>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

async function openBranchModal(editId = null) {
    currentEditId = editId;
    const modal = document.getElementById('branchModal');
    const title = document.getElementById('branchModalTitle');
    
    hideModalError('branchError');
    
    // Load clusters for dropdown if needed
    if (clustersData.length === 0) {
        await loadClusters();
    }
    
    const clusterSelect = document.getElementById('branchCluster');
    clusterSelect.innerHTML = '<option value="">Select Cluster</option>' + 
        clustersData
            .filter(c => c.is_active)
            .map(c => {
                const region = regionsData.find(r => r.id === c.region_id);
                return `<option value="${c.id}">${c.name} (${region ? region.name : '‚Äî'})</option>`;
            })
            .join('');
    
    if (editId) {
        const branch = branchesData.find(b => b.id === editId);
        title.textContent = 'Edit Branch';
        document.getElementById('branchName').value = branch.name;
        document.getElementById('branchCode').value = branch.code;
        document.getElementById('branchCluster').value = branch.cluster_id;
        document.getElementById('branchLocation').value = branch.location || '';
    } else {
        title.textContent = 'Add Branch';
        document.getElementById('branchForm').reset();
    }
    
    modal.classList.add('show');
}

function closeBranchModal() {
    document.getElementById('branchModal').classList.remove('show');
    hideModalError('branchError');
    currentEditId = null;
}

async function saveBranch() {
    const name = document.getElementById('branchName').value.trim();
    const code = document.getElementById('branchCode').value.trim().toUpperCase();
    const cluster_id = parseInt(document.getElementById('branchCluster').value);
    const location = document.getElementById('branchLocation').value.trim();

    if (!name || !code || !cluster_id) {
        showModalError('branchError', 'Please fill in all required fields');
        return;
    }

    try {
        if (currentEditId) {
            // Update existing branch
            const original = branchesData.find(b => b.id === currentEditId);
            const payload = buildPatchPayload(original, {
                name,
                code,
                cluster_id,
                location: location || null
            });

            if (Object.keys(payload).length === 0) {
                closeBranchModal();
                return;
            }

            const res = await fetch(`${API}/api/branches/${currentEditId}`, {
                method: 'PATCH',
                headers: getHeaders(),
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to update branch');
            }
        } else {
            // Create new branch
            const res = await fetch(`${API}/api/branches`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({
                    name,
                    code,
                    cluster_id,
                    location: location || null
                })
            });

            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Failed to create branch');
            }
        }

        closeBranchModal();
        loadBranches();
    } catch (err) {
        showModalError('branchError', err.message);
    }
}

function editBranch(id) {
    openBranchModal(id);
}

async function toggleBranchStatus(id, currentStatus) {
    try {
        const res = await fetch(`${API}/api/branches/${id}`, {
            method: 'PATCH',
            headers: getHeaders(),
            body: JSON.stringify({ is_active: !currentStatus })
        });
        
        if (!res.ok) throw new Error('Failed to update status');
        loadBranches();
    } catch (err) {
        alert('Failed to update branch status');
    }
}

async function deleteBranch(id) {
    if (!confirm('Are you sure you want to deactivate this branch? This action will mark it as inactive.')) return;
    
    try {
        const res = await fetch(`${API}/api/branches/${id}`, {
            method: 'DELETE',
            headers: getHeaders()
        });
        
        if (!res.ok) throw new Error('Failed to delete branch');
        loadBranches();
    } catch (err) {
        alert('Failed to delete branch');
    }
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async () => {
    if (!checkAuth()) return;

    loadUserInfo();

    // Load all data
    try {
        const [regionsRes, clustersRes, branchesRes] = await Promise.all([
            fetch(`${API}/api/regions`, { headers: getHeaders() }),
            fetch(`${API}/api/clusters`, { headers: getHeaders() }),
            fetch(`${API}/api/branches`, { headers: getHeaders() })
        ]);

        regionsData = await regionsRes.json();
        clustersData = await clustersRes.json();
        branchesData = await branchesRes.json();

        updateStats();
        renderRegions(regionsData);
    } catch (err) {
        console.error('Failed to load data:', err);
    }
});

</script>
</body>
</html>